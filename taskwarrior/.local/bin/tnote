#!/usr/bin/env sh

set -e

if [[ -z "$1" ]]; then
  TASK=$(task status:pending or status:waiting export | jq -r '.[] | (.id | tostring) + " " + .description + " +" + (.project | tostring)' | fzf --preview="previewtask {}" --prompt="task> ")
  ID=$(echo $TASK | awk '{print $1}')
  UUID=$(task _get $ID.uuid)
  PROJECT=$(task _get "$1".project)
else
  UUID=$(task _get "$1".uuid)
  PROJECT=$(task _get "$1".project)
fi

if [[ $PROJECT == "vipps"* ]]; then
  mkdir -p ~/wikis/work/taskwarrior-notes
  NOTE=~/wikis/work/taskwarrior-notes/$UUID.md
else
  mkdir -p ~/wikis/vimwiki/taskwarrior-notes
  NOTE=~/wikis/vimwiki/taskwarrior-notes/$UUID.md
fi

if [ ! -f "$NOTE" ]; then # If file does not exist
  desc=$(task _get "$1".description)
  echo "# $desc" >> $NOTE
fi

$EDITOR "$NOTE"
